#!/usr/bin/env bash
while true; do
    modprobe -r morse || true
    pinctrl set 5 op dl
    sleep 2
    pinctrl set 5 pu dh
    sleep 4
    modprobe morse enable_wiphy=0 enable_otp_check=1 country=US bcf=bcf_boardtype_0801.bin spi_clock_speed=24000000 slow_clock_mode=0 fw_bin_file=mm6108.bin debug_mask=2

    sleep 5
    echo "Checking to see if driver loaded..."
    if dmesg --since "15 seconds ago" | grep "Driver loaded with kernel module parameters"; then
        echo "Morse driver loaded!"
        pkill -f "/usr/local/bin/disp_boot.sh" || true
        /usr/local/bin/module_loaded.sh &
        break 
    else
       echo "Morse driver failed to load, trying again..."
    fi
done
